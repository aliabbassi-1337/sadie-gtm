name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Sadie GTM Ec2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 -d > ~/.ssh/key.pem
          chmod 600 ~/.ssh/key.pem

      - name: Deploy to EC2 instances
        run: |
          IPS="13.61.104.62 13.60.49.110 13.51.72.58 16.171.195.105 13.60.28.77 13.53.197.203 51.20.191.25"
          FAILED=""

          for ip in $IPS; do
            echo "=== Deploying to $ip ==="

            if ! rsync -avz --delete \
              -e "ssh -i ~/.ssh/key.pem -o ConnectTimeout=30 -o StrictHostKeyChecking=no" \
              --exclude '.git' \
              --exclude '.env' \
              --exclude '__pycache__' \
              --exclude '*.pyc' \
              --exclude '.venv' \
              --exclude 'node_modules' \
              ./ ubuntu@$ip:~/sadie-gtm/; then
              echo "FAILED rsync: $ip"
              FAILED="$FAILED $ip"
              continue
            fi

            if ! ssh -i ~/.ssh/key.pem -o ConnectTimeout=30 -o StrictHostKeyChecking=no ubuntu@$ip '
              sudo systemctl restart detection
            '; then
              echo "FAILED restart: $ip"
              FAILED="$FAILED $ip"
            fi

            echo "Done with $ip"
          done

          echo "=== Deployment complete ==="

          if [ -n "$FAILED" ]; then
            echo "::error::Deployment failed for:$FAILED"
            exit 1
          fi
