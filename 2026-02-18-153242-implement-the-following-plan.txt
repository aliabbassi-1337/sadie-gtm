
 ▐▛███▜▌   Claude Code v2.1.45
▝▜█████▛▘  Opus 4.6 · Claude Max
  ▘▘ ▝▝    ~/projects/sadie_gtm_owner_enrichment

╭──────────────────────────────────────────────────────────────────────────────╮
│ Plan to implement                                                            │
│                                                                              │
│ Plan: ABN Lookup + ASIC Director Enrichment Layer                            │
│                                                                              │
│ Context                                                                      │
│                                                                              │
│ Big4 Holiday Parks (Australian chain) all use DV certs, so CT intelligence   │
│ found zero owner names. The existing enrichment layers (RDAP, WHOIS, DNS)    │
│ also produce very low hit rates for Australian .com.au domains due to        │
│ privacy protections.                                                         │
│                                                                              │
│ ABN Lookup (abr.business.gov.au) gives us the entity behind a business. For  │
│ sole traders, the entity name IS the person's name (e.g., "PHAN, DIEU HANH"  │
│ for Daylesford Holiday Park). For Pty Ltd companies, we get the company name │
│  + ACN but still need director names.                                        │
│                                                                              │
│ ASIC has free Current Company Extracts (fees abolished Sep 2023) that        │
│ include director/officeholder names. The Business Names Register also shows  │
│ holder names for free.                                                       │
│                                                                              │
│ We need: ABN Lookup (proven HTTP scraping) → ASIC director lookup            │
│ (Playwright for Oracle ADF) → DecisionMaker with actual person names.        │
│                                                                              │
│ New Layer                                                                    │
│                                                                              │
│ LAYER_ABN_ASIC = 256 (bitmask 0b100000000) — separate from existing          │
│ LAYER_GOV_DATA=64 which queries internal DB records. This layer makes live   │
│ external calls to Australian government registries.                          │
│                                                                              │
│ Files to Create                                                              │
│                                                                              │
│ 1. lib/owner_discovery/abn_lookup.py — ABN Lookup module (HTTP scraping)     │
│                                                                              │
│ Two main functions:                                                          │
│                                                                              │
│ @dataclass                                                                   │
│ class AbnEntity:                                                             │
│     abn: str                                                                 │
│     entity_name: str        # "PHAN, DIEU HANH" or "AZZ PTY LTD"             │
│     entity_type: str        # "IND" (Individual/Sole Trader) or "PRV"        │
│ (Private Company) etc.                                                       │
│     status: str             # "Active" / "Cancelled"                         │
│     state: Optional[str]                                                     │
│     postcode: Optional[str]                                                  │
│     business_names: list[str]  # Trading names                               │
│     acn: Optional[str]      # For companies                                  │
│                                                                              │
│ async def abn_search_by_name(client, name, state=None) -> list[AbnEntity]    │
│ - POST to https://abr.business.gov.au/Search/ResultsActive with              │
│ SearchText={name}                                                            │
│ - Parse HTML table results with regex (no BS4 needed — proven in previous    │
│ session)                                                                     │
│ - For each result, follow link to /ABN/View?abn={abn} to get full details    │
│ - Extract entity type, entity name, business names, state, ACN               │
│ - Rate limit: 1 req/s                                                        │
│                                                                              │
│ async def abn_to_decision_makers(client, hotel_name, state=None) ->          │
│ tuple[list[DecisionMaker], Optional[AbnEntity]]                              │
│ - Call abn_search_by_name(), match best result to hotel name                 │
│ - If entity_type is Individual/Sole Trader → create DecisionMaker from       │
│ entity name (confidence=0.85, source="abn_lookup")                           │
│ - If entity_type is Pty Ltd → return entity with ACN for ASIC follow-up      │
│ (confidence=0.5 for org name only)                                           │
│ - Parse "SURNAME, FIRSTNAME" format into proper "Firstname Surname"          │
│                                                                              │
│ 2. lib/owner_discovery/asic_lookup.py — ASIC director lookup (httpx)         │
│                                                                              │
│ Research step first: Use Playwright to intercept all network requests when   │
│ performing an ASIC Connect search. Record the actual XHR/fetch calls,        │
│ headers, and payloads that the Oracle ADF framework sends. Then replicate    │
│ those calls with httpx.                                                      │
│                                                                              │
│ @dataclass                                                                   │
│ class AsicCompany:                                                           │
│     acn: str                                                                 │
│     company_name: str                                                        │
│     status: str                                                              │
│     directors: list[dict]   # [{"name": "John Smith", "role": "Director",    │
│ "appointed": "01/01/2020"}]                                                  │
│                                                                              │
│ async def asic_company_lookup(client: httpx.AsyncClient, acn: str) ->        │
│ Optional[AsicCompany]                                                        │
│ - Pure httpx implementation (no Playwright in production)                    │
│ - Replicate the exact HTTP calls that ASIC Connect's Oracle ADF makes        │
│ (discovered via Playwright network interception)                             │
│ - Parse HTML responses with regex to extract director names                  │
│ - Rate limit: 2s between lookups                                             │
│ - Fall back gracefully if ASIC is unavailable                                │
│                                                                              │
│ 3. db/migrations/20260218_add_abn_cache.sql                                  │
│                                                                              │
│ CREATE TABLE IF NOT EXISTS sadie_gtm.abn_lookup_cache (                      │
│     abn TEXT PRIMARY KEY,                                                    │
│     entity_name TEXT NOT NULL,                                               │
│     entity_type TEXT,          -- IND, PRV, PUB, etc.                        │
│     status TEXT,                                                             │
│     state TEXT,                                                              │
│     postcode TEXT,                                                           │
│     business_names TEXT[],                                                   │
│     acn TEXT,                                                                │
│     directors TEXT[],          -- From ASIC follow-up                        │
│     raw_data JSONB,                                                          │
│     queried_at TIMESTAMPTZ DEFAULT NOW()                                     │
│ );                                                                           │
│ CREATE INDEX IF NOT EXISTS idx_abn_cache_acn ON                              │
│ sadie_gtm.abn_lookup_cache(acn) WHERE acn IS NOT NULL;                       │
│                                                                              │
│ Files to Modify                                                              │
│                                                                              │
│ 4. services/enrichment/owner_models.py                                       │
│                                                                              │
│ - Add LAYER_ABN_ASIC = 256                                                   │
│                                                                              │
│ 5. services/enrichment/owner_enricher.py                                     │
│                                                                              │
│ - Add _run_abn_asic() layer function                                         │
│ - Wire into orchestrator after GOV_DATA, before EMAIL_VERIFY                 │
│ - Pattern: search ABN by hotel name → if sole trader, create DecisionMaker → │
│  if Pty Ltd, look up ASIC directors                                          │
│ - Update bitmask format strings (08b → 09b)                                  │
│                                                                              │
│ 6. services/enrichment/service.py                                            │
│                                                                              │
│ - Add "abn-asic": LAYER_ABN_ASIC to layer_map                                │
│ - Add ABN cache persistence in _persist_owner_results()                      │
│                                                                              │
│ 7. services/enrichment/repo.py                                               │
│                                                                              │
│ - Add cache_abn_entity() and get_cached_abn_entity() functions               │
│                                                                              │
│ 8. db/queries/owner_enrichment.sql                                           │
│                                                                              │
│ - Add cache_abn_entity and get_cached_abn_entity SQL queries                 │
│                                                                              │
│ 9. workflows/enrich_owners.py, enrich_owners_consumer.py,                    │
│ enrich_owners_enqueue.py                                                     │
│                                                                              │
│ - Add "abn-asic" to LAYER_CHOICES and LAYER_MAP (value 256)                  │
│                                                                              │
│ Implementation Order                                                         │
│                                                                              │
│ 1. Playwright research — intercept ASIC Connect network calls to             │
│ reverse-engineer the ADF API                                                 │
│ 2. ABN Lookup module (abn_lookup.py) — this is the core value, proven to     │
│ work with httpx                                                              │
│ 3. ASIC Lookup module (asic_lookup.py) — httpx implementation based on       │
│ Playwright research                                                          │
│ 4. DB migration + cache queries — store ABN/ASIC results                     │
│ 5. Wire into enricher — new layer constant + _run_abn_asic() + orchestrator  │
│ 6. CLI updates — add "abn-asic" layer choice                                 │
│ 7. Test on Big4 hotels                                                       │
│                                                                              │
│ Key Design Decisions                                                         │
│                                                                              │
│ - Playwright for research only: Use Playwright to intercept network traffic  │
│ and figure out the actual API calls. Production code uses httpx only.        │
│ - ABN first, ASIC second: ABN Lookup via HTTP is fast and reliable. ASIC     │
│ httpx calls are the second step for Pty Ltd director names.                  │
│ - Country filter: Only run this layer for Australian hotels (country = 'AU'  │
│ or .com.au domain). Skip for all others.                                     │
│ - Name matching: ABN search returns multiple results. Match by hotel name    │
│ similarity (case-insensitive substring). If multiple matches, prefer Active  │
│ status and matching state.                                                   │
│ - Sole trader name parsing: ABN returns "SURNAME, FIRSTNAME" — need to flip  │
│ to "Firstname Surname" and normalize case.                                   │
│ - Cache-first: Check abn_lookup_cache before making external requests. Cache │
│  for 30 days.                                                                │
│                                                                              │
│ Verification                                                                 │
│                                                                              │
│ # 1. Test ABN lookup module standalone                                       │
│ uv run python3 -c "                                                          │
│ import asyncio, httpx                                                        │
│ from lib.owner_discovery.abn_lookup import abn_search_by_name                │
│ async def main():                                                            │
│     async with httpx.AsyncClient() as c:                                     │
│         results = await abn_search_by_name(c, 'Big4 Holiday Parks')          │
│         for r in results: print(r)                                           │
│ asyncio.run(main())                                                          │
│ "                                                                            │
│                                                                              │
│ # 2. Run the layer on Big4 hotels                                            │
│ uv run python3 workflows/enrich_owners.py run --limit 10 --layer abn-asic    │
│                                                                              │
│ # 3. Check results                                                           │
│ uv run python3 workflows/enrich_owners.py status                             │
│                                                                              │
╰──────────────────────────────────────────────────────────────────────────────╯

⏺ I'll implement the ABN Lookup + ASIC Director Enrichment Layer. Let me start
  by reading the existing files I need to modify, then build everything
  systematically.

⏺ Let me read all the files I need to understand and modify.

⏺ Searched for 1 pattern, read 3 files (ctrl+o to expand)

⏺ Now let me read the repo.py, workflow files, and existing modules for
  patterns.

⏺ Searched for 1 pattern, read 1 file (ctrl+o to expand)

⏺ Now let me read the workflow files and the SQL queries file.

⏺ Searched for 1 pattern, read 3 files (ctrl+o to expand)

⏺ Now let me look at the SQL queries file and an existing module for patterns.

⏺ Searched for 1 pattern, read 1 file (ctrl+o to expand)

⏺ Now let me look at an existing module for structural patterns.

⏺ Read 1 file (ctrl+o to expand)

⏺ Now I have a thorough understanding. Let me also check the repo imports at the
   top.

⏺ Read 1 file (ctrl+o to expand)

⏺ Good. Now let me also check the existing owner_discovery modules list.

⏺ Searched for 1 pattern (ctrl+o to expand)

⏺ Let me also check the existing migration files to follow the naming pattern.

⏺ Searched for 2 patterns, read 1 file (ctrl+o to expand)

⏺ Now I have all the context. Let me start implementing. I'll work on Task 1
  (ABN Lookup) and Task 3 (DB migration + queries) in parallel since they're
  independent.

⏺ First, let me do the Playwright research for ASIC Connect concurrently with
  building the ABN module. Let me research the ASIC Connect API.

⏺ Task(Research ASIC Connect API)
  ⎿  Backgrounded agent (shift+↑ to manage · ctrl+o to expand)

⏺ Now let me build the ABN Lookup module. Based on the plan and proven patterns
  from the existing codebase:

⏺ Write(lib/owner_discovery/abn_lookup.py)
  ⎿  Wrote 382 lines to lib/owner_discovery/abn_lookup.py
       1 """ABN Lookup module — scrape abr.business.gov.au for business e
         ntity info.
       2 
       3 For Australian hotels, the ABN (Australian Business Number) regi
         stry reveals:
       4   - Sole traders: entity name IS the person's name (e.g., "PHAN,
          DIEU HANH")
       5   - Pty Ltd companies: company name + ACN (for ASIC director fol
         low-up)
       6 
       7 Rate limit: 1 req/s against abr.business.gov.au
       8 """
       9 
      10 import asyncio
     … +372 lines (ctrl+o to expand)

⏺ Now let me create the DB migration and SQL queries (Task 3) while the ASIC
  research runs.

⏺ Write(db/migrations/20260218_add_abn_cache.sql)
  ⎿  Wrote 20 lines to db/migrations/20260218_add_abn_cache.sql
       1 -- ABN Lookup + ASIC director cache
       2 -- Stores entity info from abr.business.gov.au and director name
         s from ASIC
       3 
       4 CREATE TABLE IF NOT EXISTS sadie_gtm.abn_lookup_cache (
       5     abn TEXT PRIMARY KEY,
       6     entity_name TEXT NOT NULL,
       7     entity_type TEXT,              -- IND, PRV, PUB, TRUST, etc.
       8     status TEXT,                   -- Active, Cancelled
       9     state TEXT,
      10     postcode TEXT,
     … +10 lines (ctrl+o to expand)
  ⎿  You've hit your limit · resets 2am (Asia/Beirut)
     /upgrade or /extra-usage to finish what you’re working on.

✻ Cooked for 2m 49s

⏺ Agent "Research ASIC Connect API" completed
  ⎿  You've hit your limit · resets 2am (Asia/Beirut)
     /upgrade or /extra-usage to finish what you’re working on.

❯ /extra-usage 
  ⎿  Login interrupted

❯ /export 
  ⎿  Conversation copied to clipboard